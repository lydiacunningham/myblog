(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d0b3a11"],{"28d9":function(e,t,a){"use strict";a.r(t);var s=function(){var e=this,t=e.$createElement;e._self._c;return e._m(0)},r=[function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("section",[a("h1",[e._v("Hot code pushes to Openshift from a Node app")]),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/800/1*gFnst2j3sKAF4Eh44RbNcg.png?style=centerme",alt:""}})]),a("p",[e._v("How move your local development to Openshift ? Here a couple of ways to push your local code changes to Openshift.")]),a("h2",[e._v("1. Create a Development Image and sync with oc RSYNC")]),a("p",[e._v('Create a docker container for your Node app see here for more information on setting this up. We need the Node app to restart if any changes are made and not kill the pod, as a new pod wouldn’t have our changes. Run your Node program as a service in the pod with forever where app.js is the starting point for your app. Remove CMD [ "npm", "start" ]and add the following to your Dockerfile.')]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[a("span",{pre:!0,attrs:{class:"hljs-comment"}},[e._v("## Installing forever in app dir")]),e._v("\nRUN npm install -g forever\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[e._v("## ignore node_modules")]),e._v("\nRUN "),a("span",{pre:!0,attrs:{class:"hljs-built_in"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v('"node_modules"')]),e._v(" >> .foreverignore\n"),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[e._v("## start app.js with forever watching for file changes the directory")]),e._v("\nCMD ["),a("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v('"forever"')]),e._v(","),a("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v('"-w"')]),e._v(","),a("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v('"--watchDirectory=/opt/app-root/src"')]),e._v(","),a("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v('"app.js"')]),e._v("]\n")])]),a("p",[a("strong",[e._v("NOTE")]),e._v(": you can do something similar with a package called nodemon")]),a("p",[e._v("Disable the liveness and readiness checks so your pod doesn’t restart when your app is restarting.")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[e._v("oc login https://openshift-cluster-url\noc project your-project-name\noc "),a("span",{pre:!0,attrs:{class:"hljs-built_in"}},[e._v("set")]),e._v(" probe dc your-app-name --liveness --readiness --remove="),a("span",{pre:!0,attrs:{class:"hljs-literal"}},[e._v("true")]),e._v("\n")])]),a("p",[e._v("Build your image and push it to dockerhub")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[e._v("docker build -t docker.io/docker-user-name/appName:tagName -f Dockerfile .\ndocker push dockerhub-user-name/appName:tagName\n")])]),a("p",[e._v("Change the image on Openshift to point to your new development image and click save.")]),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/800/1*qar2WY5lLwjw5BB2SeDCxQ.gif?style=centerme",alt:""}})]),a("p",[e._v("That’s it you now have an image deployed that will restart anytime the code base changes.")]),a("h3",[e._v("RSYNC")]),a("p",[e._v("The oc binary has an rsync (remote sync) command included, which functions in much the same way as a traditional rsync command works.")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[e._v("rsync options "),a("span",{pre:!0,attrs:{class:"hljs-built_in"}},[e._v("source")]),e._v(" destination\n")])]),a("p",[e._v("So how can you use this. First you need two pieces of information the source and the destination.")]),a("ol",[a("li",[e._v("Change to the root directory of your project.")]),a("li",[e._v("Identify the (source) directory of your code base. This could be the root directory ./ or in some Node applications is typically ./lib or ./src directory")]),a("li",[e._v("Login into your Openshift cluster and change to your project")])]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[e._v("oc login https://openshift-cluster-url\noc project your-project-name\n")])]),a("ol",{attrs:{start:"4"}},[a("li",[e._v("Get your applications pod name in Openshift (destination). Use the following command where the appName is your application name. The results returned will be the pod-name")])]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[e._v("oc get po | grep appName | grep Running | awk "),a("span",{pre:!0,attrs:{class:"hljs-string"}},[e._v("'{print $1}'")]),e._v("\nrun oc rsync\n")])]),a("p",[a("strong",[e._v("NOTE")]),e._v(": On the options we don’t want to change the permissions of the files on Openshift we use the no-prems flag, the watch flag runs rsync continuously watching for changes")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[e._v("oc rsync --watch --no-perms="),a("span",{pre:!0,attrs:{class:"hljs-literal"}},[e._v("true")]),e._v(" ./"),a("span",{pre:!0,attrs:{class:"hljs-built_in"}},[e._v("source")]),e._v(" pod-name:/opt/app-root/src\n")])]),a("p",[a("strong",[e._v("NOTE")]),e._v(": the path :/opt/app-root/src will not change, it is the default location for code in an pod\nYou will see something like")]),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/800/1*6tPkFjzzYPV1erUkgWe0pA.png?style=centerme",alt:""}})]),a("p",[e._v("Check your pod has updated by going to the pod terminal and cd to /opt/app-root/src and cat a file you have changed to see if your changes have taken effect. Also you will see app restart in the logs.")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[e._v("error: restarting script because change changed\nerror: Forever detected script was killed by signal: SIGKILL\nerror: Script restart attempt "),a("span",{pre:!0,attrs:{class:"hljs-comment"}},[e._v("#1")]),e._v("\n")])]),a("p",[a("img",{attrs:{src:"https://cdn-images-1.medium.com/max/800/1*rrTjLh0qVh9DllyNXds67Q.jpeg?style=centerme",alt:""}})]),a("h2",[e._v("2. START-BUILD from the local directory")]),a("p",[e._v("If you already have a project deployed on Openshift you can start a build directly from your local directory using the "),a("strong",[e._v("from-dir")]),e._v(" flag directory.")]),a("pre",{pre:!0},[a("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[e._v("oc login https://openshift-cluster-url\noc project your-project-name\noc start-build app-name-on-openshift --from-dir=. --"),a("span",{pre:!0,attrs:{class:"hljs-built_in"}},[e._v("wait")]),e._v("\n")])]),a("p",[e._v("This creates a local container image from your last git commit and starts a build on Openshift, This will close the current running pod on Openshift and start a new one.")]),a("p",[e._v("One thing to note with the oc start-build command is each time it is run it generates a new docker container with all the local disk space overheads. So managing local images can be an issue. But it does confirm that changes will build in Openshift unlike rsync.")])])}],o=a("2877"),n={},p=Object(o["a"])(n,s,r,!1,null,null,null);t["default"]=p.exports}}]);
//# sourceMappingURL=chunk-2d0b3a11.b28210a1.js.map