(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2d0bdd67"],{"2e64":function(s,e,t){"use strict";t.r(e);var a=function(){var s=this,e=s.$createElement;s._self._c;return s._m(0)},r=[function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("section",[t("h1",[s._v("Keycloak and Express")]),t("p",[s._v("This is a guide for setting up Express and Keycloak to protect web routes. Background Keycloak is an open source identity and access management solution that makes it easy to secure applications or microservices with little to no code. Express is a minimal and flexible Node.js web application framework. It can take a while to work your way through the official Keycloak documentation as the documentation is extensive and covers may different use cases .This a quick how to guide with minimum setup.")]),t("p",[s._v("The goal is to create an Express app that uses Keycloak to protect the ‘/test ‘ route. The login and user setup are controlled by keycloak. The default route ‘/ ‘ is unprotected. The ‘/logout’ route kills the keycloak session.")]),t("p",[s._v("To install keycloak-connect npm in your express application use the following command")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("npm install keycloak-connect --save\n")])]),t("h2",[s._v("Setup the Express server")]),t("p",[s._v("You need to import keycloak-connect and express-sessions into your express application.")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" Keycloak = "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'keycloak-connect'")]),s._v(");\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" session = "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'express-session'")]),s._v(");\n")])]),t("p",[s._v("Next configure the session to use memoryStore. Setup keycloak middleware to use the session memoryStore.")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" memoryStore = "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" session.MemoryStore();                       \n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" keycloak = "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" Keycloak({ "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("store")]),s._v(": memoryStore });\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("//session                       ")]),s._v("\napp.use(session({\n    "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("secret")]),s._v(":"),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'BeALongSecret'")]),s._v(",                         \n    "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("resave")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("false")]),s._v(",                         \n    "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("saveUninitialized")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("true")]),s._v(",                         \n    "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("store")]),s._v(": memoryStore                       \n}));\n\napp.use(keycloak.middleware());\n")])]),t("p",[s._v("You can then use keycloak.protect on your protected routes . This will check to see if a user is logged in on the keycloak server and redirect to the route. If a user is not logged in the server will redirect to the keycloak login page. User can create new accounts by clicking on the register link on the login page. This creates new users on the Keycloak server.")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("//route protected with Keycloak ")]),s._v("\napp.get(‘/test’, keycloak.protect(), "),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("req, res")]),s._v(")")]),s._v("{\n    res.render(\n        ‘test’, \n        {"),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("title")]),s._v(":’Test "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("of")]),s._v(" the test’}\n        ); \n});\n")])]),t("p",[s._v("Set the logout route to use keycloak middleware to kill the session.")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[s._v("app.use( keycloak.middleware( { "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("logout")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'/'")]),s._v("} ));\n")])]),t("p",[s._v("See the following for the full implementation of server.")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-js"}},[t("span",{pre:!0,attrs:{class:"hljs-meta"}},[s._v("\n'use strict'")]),s._v(";\n\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" Keycloak = "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'keycloak-connect'")]),s._v(");\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" express = "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'express'")]),s._v(");\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" session = "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'express-session'")]),s._v(");\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" expressHbs = "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("require")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'express-handlebars'")]),s._v(");\n\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("const")]),s._v(" app = express();\n\n\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("// Register 'handelbars' extension with The Mustache Express")]),s._v("\napp.engine("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'hbs'")]),s._v(", expressHbs({"),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("extname")]),s._v(":"),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'hbs'")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("defaultLayout")]),s._v(":"),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'layout.hbs'")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("relativeTo")]),s._v(": __dirname}));\napp.set("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'view engine'")]),s._v(", "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'hbs'")]),s._v(");\n\n\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" memoryStore = "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" session.MemoryStore();\n"),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("var")]),s._v(" keycloak = "),t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("new")]),s._v(" Keycloak({ "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("store")]),s._v(": memoryStore });\n\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("//session")]),s._v("\napp.use(session({\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("secret")]),s._v(":"),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'thisShouldBeLongAndSecret'")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("resave")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("false")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("saveUninitialized")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("true")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("store")]),s._v(": memoryStore\n}));\n\napp.use(keycloak.middleware());\n\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("//route protected with Keycloak")]),s._v("\napp.get("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'/test'")]),s._v(", keycloak.protect(), "),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("req, res")]),s._v(")")]),s._v("{\n  res.render("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'test'")]),s._v(", {"),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("title")]),s._v(":"),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Test of the test'")]),s._v("});\n});\n\n"),t("span",{pre:!0,attrs:{class:"hljs-comment"}},[s._v("//unprotected route")]),s._v("\napp.get("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'/'")]),s._v(","),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v("("),t("span",{pre:!0,attrs:{class:"hljs-params"}},[s._v("req,res")]),s._v(")")]),s._v("{\n  res.render("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'index'")]),s._v(");\n});\n\napp.use( keycloak.middleware( { "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v("logout")]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'/'")]),s._v("} ));\n\napp.listen("),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("8000")]),s._v(", "),t("span",{pre:!0,attrs:{class:"hljs-function"}},[t("span",{pre:!0,attrs:{class:"hljs-keyword"}},[s._v("function")]),s._v(" ("),t("span",{pre:!0,attrs:{class:"hljs-params"}}),s._v(") ")]),s._v("{\n  "),t("span",{pre:!0,attrs:{class:"hljs-built_in"}},[s._v("console")]),s._v(".log("),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v("'Listening at http://localhost:8000'")]),s._v(");\n});\n")])]),t("h2",[s._v("Installation of example")]),t("p",[s._v("Clone this repo and cd to the new directory run npm install, there is some extra stuff like views in the repo.")]),t("h2",[s._v("Demo Video")]),t("p",[s._v("You can see Keycloak and an Express.js server in action at\n"),t("a",{attrs:{href:"https://youtu.be/VAzI7f3pxec"}},[t("img",{attrs:{src:"https://github.com/austincunningham/keycloak-express/blob/master/keycloak-setup.jpg?raw=true",alt:"ScreenShot"}})])]),t("h2",[s._v("Setup Keycloak Server")]),t("p",[s._v("You will need to have a Keycloak server up and running to use this express application. Keycloak can be downloaded and run locally or can be run from a docker container see "),t("a",{attrs:{href:"https://hub.docker.com/r/jboss/keycloak/"}},[s._v("docker hub image")]),s._v(" for more info.")]),t("p",[s._v("Download Keycloak at "),t("a",{attrs:{href:"http://www.keycloak.org/downloads.html"}},[s._v("the download page")]),s._v(" .To run it locally unzip the downloaded file and run standalone.sh")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-bash"}},[s._v("./keycloak-unzip-directory/bin/standalone.sh\n")])]),t("p",[s._v("You can then access the Keycloak server from a browser using the following url")]),t("p",[s._v("http://localhost:8080/auth/\nYou will hit the initial password screen for Keycloak administrator .")]),t("p",[t("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/1*TnDXQpqicsMOT-Bowo3ynw.png?style=centerme",alt:""}})]),t("p",[s._v("For more information on setting up Keycloak see the following "),t("a",{attrs:{href:"https://www.keycloak.org/docs/latest/getting_started/index.html"}},[s._v("guide")])]),t("p",[s._v("Next you need to "),t("a",{attrs:{href:"http://www.keycloak.org/docs/latest/getting_started/index.html#creating-a-realm-and-user"}},[s._v("setup a Realm")]),s._v(" . Login in to Keycloak Admin Console and hover over top left hand corner and click on Add realm and give it a name.")]),t("p",[t("img",{attrs:{src:"https://cdn-images-1.medium.com/max/2400/1*8QUACOFFtq3ou5QA_UmHqQ.png?style=centerme",alt:""}}),s._v("\ncreate a realm")]),t("p",[s._v("To use the Node.js adapter, first you must create a client for your application in the Keycloak Administration Console. "),t("a",{attrs:{href:"http://www.keycloak.org/docs/latest/server_admin/index.html#_clients"}},[s._v("Setup a Open ID Connect Client")]),s._v(". In your new realm click on Clients and Create and give your client a name/ID.")]),t("p",[t("img",{attrs:{src:"https://cdn-images-1.medium.com/max/2400/1*lKPpdCLjYu6GHPfKn3MIFw.png?style=centerme",alt:""}})]),t("p",[s._v("The adapter supports public, confidential, and bearer-only access type. Which one to choose depends on the use-case scenario. In this case I picked public with openid-connect.")]),t("p",[t("img",{attrs:{src:"https://cdn-images-1.medium.com/max/2400/1*USxH7yuMSYuV6_E7zCXcKg.png?style=centerme",alt:""}})]),t("p",[s._v("You will need to define a valid redirect URL")]),t("p",[t("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1600/1*EBvShEJuRoPae84DeqX7Yw.png?style=centerme",alt:""}})]),t("p",[s._v("Once the client is created click the Installation tab, select Keycloak OIDC JSON for Format Option, and then click Download.")]),t("p",[t("img",{attrs:{src:"https://cdn-images-1.medium.com/max/2400/1*QnixBP-B0-I0nnsQQeo71A.png?style=centerme",alt:""}})]),t("p",[s._v("The downloaded keycloak.json file should be placed at the root folder of your project. Sample keycloak.json file")]),t("pre",{pre:!0},[t("code",{pre:!0,attrs:{"v-pre":"",class:"language-json"}},[s._v("{\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"realm"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"test"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"auth-server-url"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"http://localhost:8080/auth"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"ssl-required"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"external"')]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"resource"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-string"}},[s._v('"keycloak-express"')]),s._v(", \n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"public-client"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-literal"}},[s._v("true")]),s._v(",\n  "),t("span",{pre:!0,attrs:{class:"hljs-attr"}},[s._v('"confidential-port"')]),s._v(": "),t("span",{pre:!0,attrs:{class:"hljs-number"}},[s._v("0")]),s._v("\n}\n")])]),t("p",[s._v("That’s it you will have your Express web routes protected by Keycloak .For more information see "),t("a",{attrs:{href:"http://www.keycloak.org/docs/latest/securing_apps/index.html#_nodejs_adapter"}},[s._v("here")]),s._v(".")])])}],n=t("2877"),l={},o=Object(n["a"])(l,a,r,!1,null,null,null);e["default"]=o.exports}}]);
//# sourceMappingURL=chunk-2d0bdd67.bfde783a.js.map